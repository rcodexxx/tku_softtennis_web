<template>
  <div class="organization-management">
    <!-- Áèæ‰ª£ÂåñÊìç‰ΩúÈ†≠ÈÉ® -->
    <div class="management-header">
      <div class="header-info">
        <h3 class="section-title">
          <n-icon :component="BuildingIcon" class="title-icon" />
          ÁµÑÁπîÁÆ°ÁêÜ
        </h3>
      </div>

      <!--      <div class="header-actions">-->
      <!--        <n-button-->
      <!--          v-if="canManageOrganization"-->
      <!--          type="primary"-->
      <!--          size="medium"-->
      <!--          @click="openFormModal(null)"-->
      <!--          class="add-btn"-->
      <!--        >-->
      <!--          <template #icon>-->
      <!--            <n-icon :component="BuildingAddIcon" />-->
      <!--          </template>-->
      <!--          Êñ∞Â¢ûÁµÑÁπî-->
      <!--        </n-button>-->
      <!--      </div>-->
    </div>

    <!-- ÈåØË™§ÊèêÁ§∫ -->
    <n-alert v-if="fetchError" title="ËºâÂÖ•ÈåØË™§" type="error" closable class="error-alert" @close="fetchError = null">
      {{ fetchError }}
    </n-alert>

    <!-- Áèæ‰ª£ÂåñË°®Ê†º -->
    <div class="table-container">
      <n-data-table
        :columns="tableColumns"
        :data="filteredOrganizations"
        :loading="loading"
        :pagination="paginationConfig"
        :bordered="false"
        :single-line="false"
        size="medium"
        striped
        :scroll-x="800"
        class="modern-table"
      />
    </div>

    <!-- Á©∫ÁãÄÊÖã -->
    <div v-if="!loading && filteredOrganizations.length === 0" class="empty-container">
      <n-empty
        :description="searchTermProp ? `Êâæ‰∏çÂà∞Á¨¶Âêà '${searchTermProp}' ÁöÑÁµÑÁπî` : 'ÈÇÑÊ≤íÊúâÁµÑÁπîË≥áÊñô'"
        class="empty-state"
      >
        <template #extra>
          <n-button v-if="canManageOrganization && !searchTermProp" type="primary" @click="openFormModal(null)">
            Êñ∞Â¢ûÁ¨¨‰∏ÄÂÄãÁµÑÁπî
          </n-button>
        </template>
      </n-empty>
    </div>

    <!-- Áèæ‰ª£ÂåñÊñ∞Â¢û/Á∑®ËºØË°®ÂñÆÊ®°ÊÖãÊ°Ü -->
    <n-modal
      v-model:show="showFormModal"
      :mask-closable="false"
      preset="card"
      :title="isEditing ? 'Á∑®ËºØÁµÑÁπî' : 'Êñ∞Â¢ûÁµÑÁπî'"
      class="form-modal"
      :bordered="false"
    >
      <n-form
        ref="formRef"
        :model="currentOrg"
        :rules="formRules"
        label-placement="top"
        class="org-form"
        @submit.prevent="handleFormSubmit"
      >
        <div class="form-section">
          <h4 class="form-section-title">
            <n-icon :component="InfoIcon" class="section-icon" />
            Âü∫Êú¨Ë≥áË®ä
          </h4>

          <n-grid :x-gap="24" :y-gap="16" :cols="2">
            <n-form-item-gi :span="1" label="ÁµÑÁπîÂÖ®Âêç" path="name">
              <n-input v-model:value="currentOrg.name" placeholder="Ë´ãËº∏ÂÖ•ÁµÑÁπîÂÖ®Âêç" size="large" />
            </n-form-item-gi>
            <n-form-item-gi :span="1" label="ÁµÑÁπîÁ∞°Á®±" path="short_name">
              <n-input v-model:value="currentOrg.short_name" placeholder="‰æãÂ¶ÇÔºöÊ∑°Â§ßËªüÁ∂≤" size="large" />
            </n-form-item-gi>
          </n-grid>

          <n-form-item label="ÁµÑÁπîÊèèËø∞" path="description">
            <n-input
              v-model:value="currentOrg.description"
              type="textarea"
              placeholder="ÈóúÊñºÁµÑÁπîÁöÑÁ∞°‰ªãÔºàÈÅ∏Â°´Ôºâ"
              :autosize="{ minRows: 3, maxRows: 6 }"
              size="large"
            />
          </n-form-item>
        </div>

        <div class="form-section">
          <h4 class="form-section-title">
            <n-icon :component="ContactIcon" class="section-icon" />
            ËÅØÁµ°Ë≥áË®ä
          </h4>

          <n-grid :x-gap="24" :y-gap="16" :cols="2">
            <n-form-item-gi :span="1" label="‰∏ªË¶ÅËÅØÁµ°‰∫∫" path="contact_person">
              <n-input v-model:value="currentOrg.contact_person" placeholder="ËÅØÁµ°‰∫∫ÂßìÂêçÔºàÈÅ∏Â°´Ôºâ" size="large" />
            </n-form-item-gi>
            <n-form-item-gi :span="1" label="ËÅØÁµ°ÈõªË©±" path="contact_phone">
              <n-input v-model:value="currentOrg.contact_phone" placeholder="ÈõªË©±ËôüÁ¢ºÔºàÈÅ∏Â°´Ôºâ" size="large" />
            </n-form-item-gi>
          </n-grid>

          <n-form-item label="ËÅØÁµ°Email" path="contact_email">
            <n-input v-model:value="currentOrg.contact_email" placeholder="email@example.comÔºàÈÅ∏Â°´Ôºâ" size="large" />
          </n-form-item>
        </div>
      </n-form>

      <template #footer>
        <div class="modal-footer">
          <n-space justify="end" :size="16">
            <n-button size="large" @click="showFormModal = false"> ÂèñÊ∂à </n-button>
            <n-button type="primary" size="large" :loading="submitting" strong @click="handleFormSubmit">
              <template #icon>
                <n-icon :component="isEditing ? SaveIcon : AddIcon" />
              </template>
              {{ isEditing ? 'Á¢∫Ë™çÊõ¥Êñ∞' : 'Á¢∫Ë™çÊñ∞Â¢û' }}
            </n-button>
          </n-space>
        </div>
      </template>
    </n-modal>
  </div>
</template>

<script setup>
  import { computed, h, onMounted, reactive, ref, watch } from 'vue'
  import {
    NAlert,
    NButton,
    NDataTable,
    NEmpty,
    NForm,
    NFormItem,
    NFormItemGi,
    NGi,
    NGrid,
    NIcon,
    NInput,
    NModal,
    NSpace,
    NTag,
    NTooltip,
    useDialog,
    useMessage
  } from 'naive-ui'
  import {
    AddCircleOutline as BuildingAddIcon,
    PencilOutline as EditIcon,
    TrashBinOutline as DeleteIcon,
    BusinessOutline as BuildingIcon,
    InformationCircleOutline as InfoIcon,
    CallOutline as ContactIcon,
    SaveOutline as SaveIcon,
    AddOutline as AddIcon
  } from '@vicons/ionicons5'
  import apiClient from '@/services/apiClient'
  import { usePermissions } from '@/composables/usePermissions'

  // Props
  const props = defineProps({
    searchTermProp: { type: String, default: '' }
  })

  // Emits - ÈóúÈçµÔºöÁµ±Ë®àÊï∏Êìö‰∫ã‰ª∂
  const emit = defineEmits(['organization-count-update'])

  // Composables
  const dialog = useDialog()
  const message = useMessage()
  const { canManageOrganization } = usePermissions()

  // State
  const allOrganizations = ref([])
  const loading = ref(true)
  const fetchError = ref(null)

  // Modal Áõ∏ÈóúÁãÄÊÖã
  const showFormModal = ref(false)
  const isEditing = ref(false)
  const submitting = ref(false)
  const formRef = ref(null)
  const currentOrg = reactive({
    id: null,
    name: '',
    short_name: '',
    description: '',
    contact_person: '',
    contact_email: '',
    contact_phone: ''
  })

  // ÂàÜÈ†ÅÈÖçÁΩÆ
  const pagination = reactive({
    page: 1,
    pageSize: 20,
    showSizePicker: true,
    pageSizes: [10, 20, 30, 50]
  })

  // Ë°®ÂñÆÈ©óË≠âË¶èÂâá
  const formRules = {
    name: [{ required: true, message: 'ÁµÑÁπîÂÖ®ÂêçÁÇ∫ÂøÖÂ°´', trigger: ['input', 'blur'] }],
    contact_email: [{ type: 'email', message: 'Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈõªÂ≠êÈÉµ‰ª∂Ê†ºÂºè', trigger: ['blur'] }]
  }

  // Computed
  const organizationCount = computed(() => allOrganizations.value.length)

  const filteredOrganizations = computed(() => {
    if (!props.searchTermProp) return allOrganizations.value

    const term = props.searchTermProp.toLowerCase().trim()
    return allOrganizations.value.filter(
      org =>
        (org.name && org.name.toLowerCase().includes(term)) ||
        (org.short_name && org.short_name.toLowerCase().includes(term)) ||
        (org.contact_person && org.contact_person.toLowerCase().includes(term))
    )
  })

  const paginationConfig = computed(() => ({
    ...pagination,
    itemCount: filteredOrganizations.value.length,
    prefix: ({ itemCount }) => `ÂÖ± ${itemCount} ÂÄãÁµÑÁπî`
  }))

  // Ë°®Ê†ºÂàóÂÆöÁæ©
  const tableColumns = computed(() => [
    {
      title: 'ÁµÑÁπîÂêçÁ®±',
      key: 'name',
      sorter: 'default',
      width: 200,
      fixed: 'left',
      ellipsis: { tooltip: true },
      render: row => {
        return h('div', { class: 'org-name-cell' }, [
          h(
            'div',
            {
              class: 'org-name',
              onClick: () => openFormModal(row),
              style: { cursor: 'pointer' }
            },
            row.name
          ),
          row.short_name ? h('div', { class: 'org-short-name' }, `(${row.short_name})`) : null
        ])
      }
    },
    {
      title: 'ËÅØÁµ°‰∫∫',
      key: 'contact_person',
      sorter: 'default',
      width: 120,
      render: row => row.contact_person || '-'
    },
    {
      title: 'ËÅØÁµ°ÊñπÂºè',
      key: 'contact_info',
      width: 180,
      render: row => {
        const contacts = []
        if (row.contact_phone) contacts.push(`üìû ${row.contact_phone}`)
        if (row.contact_email) contacts.push(`üìß ${row.contact_email}`)
        return contacts.length > 0 ? contacts.join(' | ') : '-'
      }
    },
    {
      title: 'ÊàêÂì°Êï∏',
      key: 'members_count',
      sorter: (a, b) => (a.members_count || 0) - (b.members_count || 0),
      width: 100,
      align: 'right',
      render: row => {
        const count = row.members_count || 0
        return h(
          NTag,
          {
            type: count > 0 ? 'info' : 'default',
            size: 'small',
            round: true
          },
          {
            default: () => `${count} ‰∫∫`
          }
        )
      }
    },
    {
      title: 'Êìç‰Ωú',
      key: 'actions',
      width: 120,
      align: 'center',
      fixed: 'right',
      render: row => {
        return h(NSpace, { justify: 'center', size: 8 }, () => [
          h(
            NTooltip,
            {},
            {
              trigger: () =>
                h(
                  NButton,
                  {
                    size: 'small',
                    type: 'primary',
                    ghost: true,
                    onClick: () => openFormModal(row)
                  },
                  {
                    icon: () => h(NIcon, { component: EditIcon, size: 16 })
                  }
                ),
              default: () => 'Á∑®ËºØ'
            }
          ),

          h(
            NTooltip,
            {},
            {
              trigger: () =>
                h(
                  NButton,
                  {
                    size: 'small',
                    type: 'error',
                    ghost: true,
                    disabled: (row.members_count || 0) > 0,
                    onClick: () => confirmDelete(row)
                  },
                  {
                    icon: () => h(NIcon, { component: DeleteIcon, size: 16 })
                  }
                ),
              default: () =>
                (row.members_count || 0) > 0 ? `ÁµÑÁπîÂ∞öÊúâ ${row.members_count} ‰ΩçÊàêÂì°ÔºåÁÑ°Ê≥ïÂà™Èô§` : 'Âà™Èô§ÁµÑÁπî'
            }
          )
        ])
      }
    }
  ])

  // Methods
  const fetchOrganizations = async () => {
    loading.value = true
    fetchError.value = null

    try {
      const response = await apiClient.get('/organizations')
      allOrganizations.value = response.data || []
      console.log('‚úÖ ËºâÂÖ•ÁµÑÁπîÊï∏Êìö:', allOrganizations.value.length)

      // ÁôºÈÄÅÁµ±Ë®àÊï∏ÊìöÂà∞Áà∂ÁµÑ‰ª∂
      emit('organization-count-update', organizationCount.value)
    } catch (err) {
      fetchError.value = err.response?.data?.message || 'ÁÑ°Ê≥ïËºâÂÖ•ÁµÑÁπîÂàóË°®'
      console.error('‚ùå ËºâÂÖ•ÁµÑÁπîÂ§±Êïó:', err)
    } finally {
      loading.value = false
    }
  }

  const openFormModal = (org = null) => {
    formRef.value?.restoreValidation()

    if (org) {
      isEditing.value = true
      Object.assign(currentOrg, org)
    } else {
      isEditing.value = false
      Object.assign(currentOrg, {
        id: null,
        name: '',
        short_name: '',
        description: '',
        contact_person: '',
        contact_email: '',
        contact_phone: ''
      })
    }

    showFormModal.value = true
  }

  const handleFormSubmit = async () => {
    if (!formRef.value) return

    formRef.value.validate(async errors => {
      if (errors) {
        message.error('Ë´ãÊ™¢Êü•Ë°®ÂñÆËº∏ÂÖ•')
        return
      }

      submitting.value = true

      try {
        const payload = {
          name: currentOrg.name.trim(),
          short_name: currentOrg.short_name?.trim() || null,
          description: currentOrg.description?.trim() || null,
          contact_person: currentOrg.contact_person?.trim() || null,
          contact_email: currentOrg.contact_email?.trim() || null,
          contact_phone: currentOrg.contact_phone?.trim() || null
        }

        if (isEditing.value) {
          await apiClient.put(`/organizations/${currentOrg.id}`, payload)
          message.success('ÁµÑÁπîÂ∑≤ÊàêÂäüÊõ¥Êñ∞ÔºÅ')
        } else {
          await apiClient.post('/organizations', payload)
          message.success('ÁµÑÁπîÂ∑≤ÊàêÂäüÊñ∞Â¢ûÔºÅ')
        }

        showFormModal.value = false
        await fetchOrganizations()
      } catch (err) {
        message.error(err.response?.data?.message || 'Êìç‰ΩúÂ§±Êïó')
      } finally {
        submitting.value = false
      }
    })
  }

  const confirmDelete = org => {
    dialog.error({
      title: 'Á¢∫Ë™çÂà™Èô§ÁµÑÁπî',
      content: `ÊÇ®Á¢∫ÂÆöË¶ÅÂà™Èô§ÁµÑÁπî "${org.name}" ÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`,
      positiveText: 'Á¢∫Ë™çÂà™Èô§',
      negativeText: 'ÂèñÊ∂à',
      onPositiveClick: async () => {
        try {
          await apiClient.delete(`/organizations/${org.id}`)
          message.success(`ÁµÑÁπî "${org.name}" Â∑≤ÊàêÂäüÂà™Èô§`)
          await fetchOrganizations()
        } catch (err) {
          message.error(err.response?.data?.message || 'Âà™Èô§ÁµÑÁπîÂ§±Êïó')
        }
      }
    })
  }

  // Watchers
  watch(
    organizationCount,
    newCount => {
      console.log('üìä ÁµÑÁπîÊï∏ÈáèËÆäÂåñ:', newCount)
      emit('organization-count-update', newCount)
    },
    { immediate: true }
  )

  watch(
    () => props.searchTermProp,
    () => {
      pagination.page = 1
    }
  )

  // Lifecycle
  onMounted(() => {
    fetchOrganizations()
  })

  defineExpose({
    openFormModal,
    fetchOrganizations
  })
</script>

<style scoped>
  .organization-management {
    height: 100%;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Áèæ‰ª£ÂåñÈ†≠ÈÉ® */
  .management-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .header-info {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #334155;
  }

  .title-icon {
    font-size: 1.5rem;
    color: #f093fb;
  }

  .stats-mini {
    display: flex;
    gap: 0.75rem;
  }

  .header-actions {
    display: flex;
    gap: 1rem;
  }

  .add-btn {
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    border: none;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);
  }

  .add-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(240, 147, 251, 0.4);
  }

  /* ÈåØË™§ÊèêÁ§∫ */
  .error-alert {
    border-radius: 12px;
  }

  /* Ë°®Ê†ºÂÆπÂô® */
  .table-container {
    flex: 1;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .modern-table {
    border-radius: 12px;
    overflow: hidden;
  }

  /* ÁµÑÁπîÂêçÁ®±ÂñÆÂÖÉÊ†º */
  .org-name-cell {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .org-name {
    font-weight: 600;
    color: #1a202c;
    transition: color 0.2s ease;
  }

  .org-name:hover {
    color: #f093fb;
    text-decoration: underline;
  }

  .org-short-name {
    font-size: 0.75rem;
    color: #64748b;
    font-style: italic;
  }

  /* Á©∫ÁãÄÊÖã */
  .empty-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
  }

  .empty-state {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 3rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  /* Ë°®ÂñÆÊ®°ÊÖãÊ°Ü */
  .form-modal {
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    max-width: 700px;
    width: 90vw;
  }

  .org-form {
    max-height: 70vh;
    overflow-y: auto;
    padding-right: 1rem;
  }

  .form-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: rgba(248, 250, 252, 0.5);
    border-radius: 12px;
    border: 1px solid rgba(226, 232, 240, 0.6);
  }

  .form-section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0 0 1rem 0;
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
  }

  .section-icon {
    font-size: 1.25rem;
    color: #667eea;
  }

  .modal-footer {
    padding-top: 1rem;
    border-top: 1px solid rgba(226, 232, 240, 0.6);
  }

  /* Ë°®Ê†ºÂ¢ûÂº∑ */
  :deep(.modern-table .n-data-table) {
    background: transparent;
  }

  :deep(.modern-table .n-data-table-thead) {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  }

  :deep(.modern-table .n-data-table-th) {
    font-weight: 700;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
    background: transparent;
  }

  :deep(.modern-table .n-data-table-td) {
    transition: background-color 0.2s ease;
  }

  :deep(.modern-table .n-data-table-tr:hover) {
    background: linear-gradient(135deg, rgba(240, 147, 251, 0.02) 0%, rgba(245, 87, 108, 0.02) 100%);
  }

  /* ÈüøÊáâÂºèË®≠Ë®à */
  @media (max-width: 768px) {
    .management-header {
      flex-direction: column;
      gap: 1rem;
      align-items: stretch;
    }

    .header-info {
      justify-content: space-between;
    }

    .stats-mini {
      justify-content: center;
    }

    .table-container {
      padding: 1rem;
    }

    .form-modal {
      width: 95vw;
      max-width: none;
    }

    .org-form {
      padding-right: 0;
    }
  }
</style>
