<template>
  <div class="match-score-display-container" :class="{ 'readonly-mode': readOnly }">
    <!-- Âü∫Êú¨ÊØîÂàÜÈ°ØÁ§∫ -->
    <n-card title="ÊØîË≥ΩÂàÜÊï∏" size="small" :bordered="false">
      <div class="simplified-score-container">
        <!-- Èöä‰ºçAÊéßÂà∂ -->
        <div class="team-score-control">
          <div class="team-label-simple">{{ teamAName }}</div>
          <div class="score-buttons" v-if="!readOnly">
            <n-button
              :disabled="!allowScoreAdjustment || modelValue.a_games <= 0"
              circle
              size="small"
              type="error"
              ghost
              @click="adjustScore('a_games', -1)"
            >
              <n-icon :component="MinusIcon" />
            </n-button>
            <n-button
              :disabled="!allowScoreAdjustment || modelValue.a_games >= scoreInputMax"
              circle
              size="small"
              type="primary"
              ghost
              @click="adjustScore('a_games', 1)"
            >
              <n-icon :component="AddIcon" />
            </n-button>
          </div>
        </div>

        <!-- ÂàÜÊï∏È°ØÁ§∫ -->
        <div class="enhanced-score-display">
          <div
            class="score-display-enhanced"
            :class="{ clickable: !readOnly }"
            :title="scoreTooltipText"
            @click="readOnly ? null : showScoreDetails"
          >
            <span class="score-team-a" :class="{ winner: isTeamAWinner }">
              {{ modelValue.a_games || 0 }}
              <span v-if="tiebreakScoreDisplay?.showOnA" class="tiebreak-superscript">
                <sup>{{ tiebreakScoreDisplay.loserScore }}</sup>
              </span>
            </span>
            <span class="score-separator">:</span>
            <span class="score-team-b" :class="{ winner: isTeamBWinner }">
              {{ modelValue.b_games || 0 }}
              <span v-if="tiebreakScoreDisplay?.showOnB" class="tiebreak-superscript">
                <sup>{{ tiebreakScoreDisplay.loserScore }}</sup>
              </span>
            </span>
          </div>
        </div>

        <!-- Èöä‰ºçBÊéßÂà∂ -->
        <div class="team-score-control">
          <div class="team-label-simple">{{ teamBName }}</div>
          <div class="score-buttons" v-if="!readOnly">
            <n-button
              :disabled="!allowScoreAdjustment || modelValue.b_games <= 0"
              circle
              size="small"
              type="error"
              ghost
              @click="adjustScore('b_games', -1)"
            >
              <n-icon :component="MinusIcon" />
            </n-button>
            <n-button
              :disabled="!allowScoreAdjustment || modelValue.b_games >= scoreInputMax"
              circle
              size="small"
              type="primary"
              ghost
              @click="adjustScore('b_games', 1)"
            >
              <n-icon :component="AddIcon" />
            </n-button>
          </div>
        </div>
      </div>
    </n-card>

    <!-- Ë©≥Á¥∞Ë®≠ÂÆöÂçÄÂ°ä -->
    <n-divider style="margin-top: 2rem; margin-bottom: 1rem">
      <n-button
        text
        style="color: #666; font-size: 14px"
        :disabled="mode === 'view'"
        @click="toggleAdvancedSettings"
      >
        <template #icon>
          <n-icon :component="showAdvancedSettings ? ChevronDownIcon : ChevronUpIcon" />
        </template>
        {{ readOnly ? 'Ë©≥Á¥∞Ë≥áË®ä' : 'Ë©≥Á¥∞Ë®≠ÂÆö' }}
      </n-button>
    </n-divider>

    <!-- Ë©≥Á¥∞Ë®≠ÂÆöÂÖßÂÆπ -->
    <div v-show="shouldShowAdvancedSettings" class="advanced-settings-container">
      <div class="detailed-score-section">
        <!-- ÊéßÂà∂Èù¢Êùø -->
        <div class="control-panel">
          <div class="serve-selector-buttons">
            <n-form-item label="ÂÖàÁôºÁêÉÊñπ" :show-feedback="false" size="small">
              <div class="serve-button-group">
                <n-button
                  :type="modelValue.first_serve_side === 'side_a' ? 'primary' : 'default'"
                  :ghost="modelValue.first_serve_side !== 'side_a'"
                  size="large"
                  class="serve-button"
                  :disabled="readOnly"
                  @click="readOnly ? null : setFirstServe('side_a')"
                >
                  <template #icon>
                    <span class="serve-icon">üéæ</span>
                  </template>
                  AÊñπÂÖàÁôº
                </n-button>
                <n-button
                  :type="modelValue.first_serve_side === 'side_b' ? 'primary' : 'default'"
                  :ghost="modelValue.first_serve_side !== 'side_b'"
                  size="large"
                  class="serve-button"
                  :disabled="readOnly"
                  @click="readOnly ? null : setFirstServe('side_b')"
                >
                  <template #icon>
                    <span class="serve-icon">üéæ</span>
                  </template>
                  BÊñπÂÖàÁôº
                </n-button>
              </div>
            </n-form-item>
          </div>
        </div>

        <!-- Á¥ÄÈåÑÊ®°Âºè - Áõ¥Êé•È°ØÁ§∫ -->
        <div class="record-mode">
          <!-- Ê°åÈù¢ÁâàÔºöÁ∂≤Ê†º‰ΩàÂ±Ä -->
          <div class="desktop-grid">
            <n-grid :x-gap="12" :y-gap="12" :cols="getRecordCardsPerRow">
              <n-grid-item v-for="gameNum in maxGames" :key="gameNum">
                <n-card
                  size="small"
                  class="game-score-card"
                  :class="{
                    'completed-card': isGameCompleted(gameNum),
                    'disabled-card': isGameDisabled(gameNum) || readOnly,
                    'invalid-card': getScoreInputStatus(gameNum)?.type === 'error',
                    'tiebreak-card': isTiebreakGame(gameNum),
                    'winner-a-card': isGameCompleted(gameNum) && getGameWinner(gameNum) === 'A',
                    'winner-b-card': isGameCompleted(gameNum) && getGameWinner(gameNum) === 'B',
                    'readonly-card': readOnly
                  }"
                >
                  <template #header>
                    <div class="card-game-header">
                      <div class="card-title-section">
                        <span>{{ getGameTitle(gameNum) }}</span>
                        <n-tag v-if="isTiebreakGame(gameNum)" type="warning" size="small" round>
                          Ê±∫ÂãùÂ±Ä
                        </n-tag>
                      </div>
                      <div class="card-status">
                        <n-tag
                          v-if="isGameCompleted(gameNum)"
                          :type="getGameResultType(gameNum)"
                          size="small"
                          round
                        >
                          {{ getGameResult(gameNum) }}
                        </n-tag>
                      </div>
                    </div>
                  </template>

                  <n-space vertical :size="8">
                    <!-- AÊñπËº∏ÂÖ• -->
                    <n-form-item :show-feedback="false" size="small">
                      <template #label>
                        <div class="team-label">
                          <span
                            v-if="isATeamServing(gameNum)"
                            class="serve-icon card-serve-icon"
                            title="AÊñπÁôºÁêÉ"
                          >üéæ</span>
                          <span>AÊñπ</span>
                        </div>
                      </template>
                      <n-input-number
                        v-model:value="modelValue[`game${gameNum}_a_score`]"
                        :min="0"
                        :max="getMaxScoreForGame(gameNum, 'a')"
                        :disabled="isGameDisabled(gameNum) || readOnly"
                        :readonly="readOnly"
                        :status="getScoreInputStatus(gameNum)?.type"
                        size="small"
                        style="width: 100%"
                        @update:value="readOnly ? null : updateGameStatistics"
                      />
                    </n-form-item>

                    <!-- BÊñπËº∏ÂÖ• -->
                    <n-form-item :show-feedback="false" size="small">
                      <template #label>
                        <div class="team-label">
                          <span
                            v-if="isBTeamServing(gameNum)"
                            class="serve-icon card-serve-icon"
                            title="BÊñπÁôºÁêÉ"
                          >üéæ</span>
                          <span>BÊñπ</span>
                        </div>
                      </template>
                      <n-input-number
                        v-model:value="modelValue[`game${gameNum}_b_score`]"
                        :min="0"
                        :max="getMaxScoreForGame(gameNum, 'b')"
                        :disabled="isGameDisabled(gameNum) || readOnly"
                        :readonly="readOnly"
                        :status="getScoreInputStatus(gameNum)?.type"
                        size="small"
                        style="width: 100%"
                        @update:value="readOnly ? null : updateGameStatistics"
                      />
                    </n-form-item>
                  </n-space>
                </n-card>
              </n-grid-item>
            </n-grid>
          </div>

          <!-- ÁßªÂãïÁâàÔºöÂûÇÁõ¥ÊéíÂàó + ÂèØÊë∫Áñä -->
          <div class="mobile-vertical">
            <div v-for="gameNum in maxGames" :key="gameNum" class="mobile-game-item">
              <div
                class="mobile-game-header"
                :class="{
                  'completed-header': isGameCompleted(gameNum),
                  'tiebreak-header': isTiebreakGame(gameNum),
                  'winner-a-header': isGameCompleted(gameNum) && getGameWinner(gameNum) === 'A',
                  'winner-b-header': isGameCompleted(gameNum) && getGameWinner(gameNum) === 'B'
                }"
                @click="toggleMobileGame(gameNum)"
              >
                <div class="mobile-game-title">
                  <span class="game-number">{{ getGameTitle(gameNum) }}</span>
                  <div class="header-tags">
                    <n-tag v-if="isTiebreakGame(gameNum)" type="warning" size="small" round>
                      Ê±∫ÂãùÂ±Ä
                    </n-tag>
                    <n-tag
                      v-if="isGameCompleted(gameNum)"
                      :type="getGameResultType(gameNum)"
                      size="small"
                      round
                    >
                      {{ getGameResult(gameNum) }}
                    </n-tag>
                  </div>
                </div>
                <div class="header-right">
                  <span v-if="hasGameScore(gameNum)" class="quick-score">
                    {{ modelValue[`game${gameNum}_a_score`] || 0 }}:{{ modelValue[`game${gameNum}_b_score`] || 0 }}
                  </span>
                  <n-icon
                    :component="collapsedGames.includes(gameNum) ? ChevronDownIcon : ChevronUpIcon"
                    class="collapse-icon"
                  />
                </div>
              </div>

              <div v-if="!collapsedGames.includes(gameNum)" class="mobile-game-content">
                <n-card
                  size="small"
                  class="mobile-card"
                  :class="{
                    'completed-card': isGameCompleted(gameNum),
                    'disabled-card': isGameDisabled(gameNum) || readOnly,
                    'invalid-card': getScoreInputStatus(gameNum)?.type === 'error',
                    'tiebreak-card': isTiebreakGame(gameNum),
                    'winner-a-card': isGameCompleted(gameNum) && getGameWinner(gameNum) === 'A',
                    'winner-b-card': isGameCompleted(gameNum) && getGameWinner(gameNum) === 'B',
                    'readonly-card': readOnly
                  }"
                >
                  <n-space vertical :size="8">
                    <n-form-item :show-feedback="false" size="small">
                      <template #label>
                        <div class="team-label">
                          <span
                            v-if="isATeamServing(gameNum)"
                            class="serve-icon card-serve-icon"
                            title="AÊñπÁôºÁêÉ"
                          >üéæ</span>
                          <span>AÊñπ</span>
                        </div>
                      </template>
                      <n-input-number
                        v-model:value="modelValue[`game${gameNum}_a_score`]"
                        :min="0"
                        :max="getMaxScoreForGame(gameNum, 'a')"
                        :disabled="isGameDisabled(gameNum) || readOnly"
                        :readonly="readOnly"
                        :status="getScoreInputStatus(gameNum)?.type"
                        size="small"
                        style="width: 100%"
                        @update:value="readOnly ? null : updateGameStatistics"
                      />
                    </n-form-item>

                    <n-form-item :show-feedback="false" size="small">
                      <template #label>
                        <div class="team-label">
                          <span
                            v-if="isBTeamServing(gameNum)"
                            class="serve-icon card-serve-icon"
                            title="BÊñπÁôºÁêÉ"
                          >üéæ</span>
                          <span>BÊñπ</span>
                        </div>
                      </template>
                      <n-input-number
                        v-model:value="modelValue[`game${gameNum}_b_score`]"
                        :min="0"
                        :max="getMaxScoreForGame(gameNum, 'b')"
                        :disabled="isGameDisabled(gameNum) || readOnly"
                        :readonly="readOnly"
                        :status="getScoreInputStatus(gameNum)?.type"
                        size="small"
                        style="width: 100%"
                        @update:value="readOnly ? null : updateGameStatistics"
                      />
                    </n-form-item>
                  </n-space>
                </n-card>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ë©≥Á¥∞ÊØîÂàÜÂΩàÁ™ó -->
    <n-modal
      v-model:show="showScoreModal"
      preset="card"
      title="Ë©≥Á¥∞ÊØîÂàÜ"
      style="width: 90%; max-width: 600px"
      :mask-closable="true"
    >
      <div class="score-modal-content">
        <div v-if="hasDetailedScoreDataModal" class="detailed-scores-grid">
          <div
            v-for="gameNum in maxGames"
            :key="gameNum"
            class="score-game-card"
            :class="{
              'tiebreak-card': isTiebreakGame(gameNum),
              'completed-card': isGameCompleted(gameNum),
              'winner-a-card': getGameWinner(gameNum) === 'A',
              'winner-b-card': getGameWinner(gameNum) === 'B'
            }"
          >
            <div class="game-header">
              <span class="game-title">Á¨¨{{ gameNum }}Â±Ä</span>
              <span v-if="isTiebreakGame(gameNum)" class="tiebreak-badge"> Ê±∫ÂãùÂ±Ä </span>
            </div>

            <div class="game-score-display">
              <template v-if="hasGameScore(gameNum)">
                <span class="team-score team-a">{{ getGameScore(gameNum).aScore }}</span>
                <span class="score-sep">:</span>
                <span class="team-score team-b">{{ getGameScore(gameNum).bScore }}</span>
              </template>
              <span v-else class="no-score">Êú™ÈÄ≤Ë°å</span>
            </div>

            <div v-if="isGameCompleted(gameNum)" class="game-result" :class="{ 'result-a': getGameWinner(gameNum) === 'A', 'result-b': getGameWinner(gameNum) === 'B' }">
              {{ getGameWinner(gameNum) === 'A' ? 'AÊñπÁç≤Âãù' : 'BÊñπÁç≤Âãù' }}
            </div>

            <div v-else-if="hasGameScore(gameNum)" class="game-status">ÈÄ≤Ë°å‰∏≠</div>
          </div>
        </div>

        <div v-else class="no-detailed-data">
          <div class="empty-icon">üìä</div>
          <h3>Êö´ÁÑ°Ë©≥Á¥∞ÊØîÂàÜ</h3>
          <p>Ê≠§ÊØîË≥ΩÊú™Ë®òÈåÑË©≥Á¥∞ÁöÑÂ±ÄÊØîÂàÜÊï∏Êìö</p>
        </div>
      </div>

      <template #footer>
        <n-space justify="end">
          <n-button @click="showScoreModal = false">ÈóúÈñâ</n-button>
        </n-space>
      </template>
    </n-modal>
  </div>
</template>

<script setup>
import { computed, ref, watch, nextTick, onMounted } from 'vue'
import { useMessage, NStatistic, NGrid, NDivider, NText } from 'naive-ui'

import {
  AddOutline as AddIcon,
  CheckmarkCircleOutline as CheckmarkCircleIcon,
  RemoveOutline as MinusIcon,
  InformationCircleOutline as InfoIcon,
  ChevronUpOutline as ChevronUpIcon,
  ChevronDownOutline as ChevronDownIcon,
  LockClosedOutline
} from '@vicons/ionicons5'

const props = defineProps({
  modelValue: {
    type: Object,
    required: true
  },
  teamAName: {
    type: String,
    default: 'Èöä‰ºç A'
  },
  teamBName: {
    type: String,
    default: 'Èöä‰ºç B'
  },
  allowScoreAdjustment: {
    type: Boolean,
    default: true
  },
  readOnly: {
    type: Boolean,
    default: false
  },
  mode: {
    type: String,
    default: 'add',
    validator: value => ['add', 'edit', 'view'].includes(value)
  }
})

const emit = defineEmits(['update:modelValue', 'score-changed', 'match-completed'])

const message = useMessage()
const showAdvancedSettings = ref(false)
const showScoreModal = ref(false)
const collapsedGames = ref([])

// Ë®àÁÆóÂ±¨ÊÄß
const maxGames = computed(() => {
  const format = props.modelValue.match_format
  const matchFormatConfig = {
    games_5: { maxGames: 5 },
    games_7: { maxGames: 7 },
    games_9: { maxGames: 9 }
  }
  return format ? matchFormatConfig[format]?.maxGames || 9 : 9
})

const scoreInputMax = computed(() => {
  const formatMap = {
    games_5: 3,
    games_7: 4,
    games_9: 5
  }
  return formatMap[props.modelValue.match_format] || 5
})

const gamesToWin = computed(() => scoreInputMax.value)

const isTeamAWinner = computed(() => {
  const aGames = props.modelValue.a_games || 0
  const bGames = props.modelValue.b_games || 0
  return aGames >= gamesToWin.value && aGames > bGames
})

const isTeamBWinner = computed(() => {
  const aGames = props.modelValue.a_games || 0
  const bGames = props.modelValue.b_games || 0
  return bGames >= gamesToWin.value && bGames > aGames
})

const matchCompleted = computed(() => {
  return detailedStats.value.aWins >= gamesToWin.value || detailedStats.value.bWins >= gamesToWin.value
})

const getRecordCardsPerRow = computed(() => {
  return 5
})

const shouldShowAdvancedSettings = computed(() => {
  if (props.readOnly || props.mode === 'view') {
    return true
  }
  return showAdvancedSettings.value
})

// Ê™¢Ê∏¨Ë©≥Á¥∞ÊØîÂàÜÊï∏Êìö
const hasDetailedScoreData = computed(() => {
  for (let i = 1; i <= maxGames.value; i++) {
    const aScore = props.modelValue[`game${i}_a_score`] || 0
    const bScore = props.modelValue[`game${i}_b_score`] || 0
    if (aScore > 0 || bScore > 0) {
      return true
    }
  }
  return false
})

const hasDetailedScoreDataModal = computed(() => hasDetailedScoreData.value)

// ÂãïÊÖãË®àÁÆóÊØèÂ±ÄÊØîÂàÜÁöÑÊúÄÂ§ßÂÄº
const getMaxScoreForGame = computed(() => {
  return (gameNum, side) => {
    // Â¶ÇÊûúÊòØÊ±∫ÂãùÂ±ÄÔºå‰ΩøÁî®Ê±∫ÂãùÂ±ÄË¶èÂâá
    if (isTiebreakGame(gameNum)) {
      return 50 // Ê±∫ÂãùÂ±ÄÁÑ°‰∏äÈôê
    }

    const aScore = props.modelValue[`game${gameNum}_a_score`] || 0
    const bScore = props.modelValue[`game${gameNum}_b_score`] || 0

    // Áï∂ÂâçÊñπÂàÜÊï∏ÂíåÂ∞çÊñπÂàÜÊï∏
    const currentScore = side === 'a' ? aScore : bScore
    const opponentScore = side === 'a' ? bScore : aScore

    // ËªüÂºèÁ∂≤ÁêÉË¶èÂâáÔºö
    // 1. Â¶ÇÊûúÂ∞çÊñπÂàÜÊï∏ < 3ÔºåÊúÄÈ´òÂè™ËÉΩÂà∞ 4 ÂàÜ
    // 2. Â¶ÇÊûúÂ∞çÊñπÂàÜÊï∏ >= 3ÔºåÁÑ°‰∏äÈôêÔºà‰ΩÜË®≠ÁΩÆÂêàÁêÜ‰∏äÈôêÔºâ
    if (opponentScore < 3) {
      return 4
    } else {
      return 50 // 3:3 ÂæåÁÑ°‰∏äÈôê
    }
  }
})

const getServeLabel = computed(() => {
  if (!props.modelValue.first_serve_side) return 'ÂÖàÁôº'
  return props.modelValue.first_serve_side === 'side_a' ? 'AÂÖàÁôº' : 'BÂÖàÁôº'
})

const getServeValue = computed(() => {
  if (!props.modelValue.first_serve_side) return '?'
  return props.modelValue.first_serve_side === 'side_a' ? 'üèì A' : 'üèì B'
})

const tiebreakScoreDisplay = computed(() => {
  const tiebreakGame = getTiebreakGameNumber()
  if (!tiebreakGame || !isGameCompleted(tiebreakGame)) {
    return null
  }

  const aScore = props.modelValue[`game${tiebreakGame}_a_score`] || 0
  const bScore = props.modelValue[`game${tiebreakGame}_b_score`] || 0

  const tiebreakWinner = aScore > bScore ? 'A' : 'B'
  const loserScore = tiebreakWinner === 'A' ? bScore : aScore

  return {
    aScore,
    bScore,
    loserScore,
    winner: tiebreakWinner,
    showOnA: tiebreakWinner === 'B',
    showOnB: tiebreakWinner === 'A'
  }
})

const scoreTooltipText = computed(() => {
  if (props.readOnly) {
    return 'Ë©≥Á¥∞ÊØîÂàÜË≥áË®äÔºàÂè™ËÆÄÊ®°ÂºèÔºâ'
  }
  if (!hasDetailedScoreData.value) {
    return 'ÈªûÊìäÊü•ÁúãË©≥Á¥∞ÊØîÂàÜ'
  }
  return 'ÈªûÊìäÊü•ÁúãË©≥Á¥∞ÊØîÂàÜË®òÈåÑ'
})

// Ë©≥Á¥∞Áµ±Ë®à
const detailedStats = computed(() => {
  let aWins = 0
  let bWins = 0
  let completedGames = 0
  let totalPoints = 0
  let inProgressGames = 0

  for (let i = 1; i <= maxGames.value; i++) {
    const aScore = props.modelValue[`game${i}_a_score`] || 0
    const bScore = props.modelValue[`game${i}_b_score`] || 0

    if (aScore > 0 || bScore > 0) {
      totalPoints += aScore + bScore

      const validation = validateSoftTennisScore(aScore, bScore, i)

      if (validation.gameFinished && validation.winner) {
        completedGames++
        if (validation.winner === 'A') {
          aWins++
        } else {
          bWins++
        }
      } else if (validation.isValid) {
        inProgressGames++
      }
    }
  }

  return {
    aWins,
    bWins,
    completedGames,
    totalPoints,
    inProgressGames,
    totalActiveGames: completedGames + inProgressGames
  }
})

// ËºîÂä©ÂáΩÊï∏
const getTiebreakGameNumber = () => {
  const format = props.modelValue.match_format
  if (format === 'games_5') return 5
  if (format === 'games_7') return 7
  if (format === 'games_9') return 9
  return null
}

const isTiebreakGame = (gameNum) => {
  const format = props.modelValue.match_format
  if (format === 'games_5' && gameNum === 5) return true
  if (format === 'games_7' && gameNum === 7) return true
  if (format === 'games_9' && gameNum === 9) return true
  return false
}

const getGameServeTeam = (gameNum) => {
  if (!props.modelValue.first_serve_side) return null

  if (gameNum % 2 === 1) {
    return props.modelValue.first_serve_side
  } else {
    return props.modelValue.first_serve_side === 'side_a' ? 'side_b' : 'side_a'
  }
}

const isATeamServing = (gameNum) => {
  return getGameServeTeam(gameNum) === 'side_a'
}

const isBTeamServing = (gameNum) => {
  return getGameServeTeam(gameNum) === 'side_b'
}

const isGameCompleted = (gameNum) => {
  const aScore = props.modelValue[`game${gameNum}_a_score`] || 0
  const bScore = props.modelValue[`game${gameNum}_b_score`] || 0

  if (aScore === 0 && bScore === 0) return false

  const validation = validateSoftTennisScore(aScore, bScore, gameNum)
  return validation.gameFinished
}

const isGameDisabled = (gameNum) => {
  return matchCompleted.value && !isGameCompleted(gameNum)
}

const getGameResult = (gameNum) => {
  const aScore = props.modelValue[`game${gameNum}_a_score`] || 0
  const bScore = props.modelValue[`game${gameNum}_b_score`] || 0

  const validation = validateSoftTennisScore(aScore, bScore, gameNum)

  if (validation.gameFinished && validation.winner) {
    return validation.winner === 'A' ? 'AÂãù' : 'BÂãù'
  }

  return 'ÈÄ≤Ë°å‰∏≠'
}

const getGameWinner = (gameNum) => {
  if (!isGameCompleted(gameNum)) return null

  const aScore = props.modelValue[`game${gameNum}_a_score`] || 0
  const bScore = props.modelValue[`game${gameNum}_b_score`] || 0

  return aScore > bScore ? 'A' : 'B'
}

const hasGameScore = (gameNum) => {
  const aScore = props.modelValue[`game${gameNum}_a_score`] || 0
  const bScore = props.modelValue[`game${gameNum}_b_score`] || 0
  return aScore > 0 || bScore > 0
}

const getGameScore = (gameNum) => {
  const aScore = props.modelValue[`game${gameNum}_a_score`] || 0
  const bScore = props.modelValue[`game${gameNum}_b_score`] || 0
  return { aScore, bScore }
}

const validateSoftTennisScore = (aScore, bScore, gameNum = null) => {
  if (aScore < 0 || bScore < 0) {
    return { isValid: false, message: 'ÂàÜÊï∏‰∏çËÉΩÁÇ∫Ë≤†Êï∏' }
  }
  if (aScore > 50 || bScore > 50) {
    return { isValid: false, message: 'ÂàÜÊï∏ÈÅéÈ´òÔºåË´ãÊ™¢Êü•Ëº∏ÂÖ•' }
  }

  if (aScore === 0 && bScore === 0) {
    return { isValid: true, message: '', gameFinished: false, winner: null }
  }

  const isTiebreak = gameNum && isTiebreakGame(gameNum)

  if (isTiebreak) {
    return validateTiebreakScore(aScore, bScore)
  } else {
    return validateRegularGameScore(aScore, bScore)
  }
}

const validateTiebreakScore = (aScore, bScore) => {
  const minScore = Math.min(aScore, bScore)
  const maxScore = Math.max(aScore, bScore)
  const scoreDiff = Math.abs(aScore - bScore)

  if (minScore < 6) {
    if (maxScore >= 7 && scoreDiff >= 1) {
      const winner = aScore > bScore ? 'A' : 'B'
      return { isValid: true, message: '', gameFinished: true, winner }
    }
    if (maxScore >= 7 && scoreDiff < 1) {
      return { isValid: false, message: 'ÂàÜÊï∏Â∑≤ÈÅîÂà∞ÂãùË≤†Èªû‰ΩÜÊú™ÊãâÈñãÂ∑ÆË∑ùÔºåÁÑ°Êïà' }
    }
    return { isValid: true, message: '', gameFinished: false, winner: null }
  }

  if (minScore >= 6) {
    if (scoreDiff >= 2) {
      const winner = aScore > bScore ? 'A' : 'B'
      return { isValid: true, message: '', gameFinished: true, winner }
    }
    return { isValid: true, message: '', gameFinished: false, winner: null }
  }

  return { isValid: true, message: '', gameFinished: false, winner: null }
}

const validateRegularGameScore = (aScore, bScore) => {
  const minScore = Math.min(aScore, bScore)
  const maxScore = Math.max(aScore, bScore)
  const scoreDiff = Math.abs(aScore - bScore)

  if (maxScore >= 4 && minScore < 3) {
    const winner = aScore > bScore ? 'A' : 'B'
    return { isValid: true, message: '', gameFinished: true, winner }
  }

  if (maxScore < 4) {
    return { isValid: true, message: '', gameFinished: false, winner: null }
  }

  if (minScore >= 3) {
    if (scoreDiff >= 2) {
      const winner = aScore > bScore ? 'A' : 'B'
      return { isValid: true, message: '', gameFinished: true, winner }
    }
    return { isValid: true, message: '', gameFinished: false, winner: null }
  }

  return { isValid: true, message: '', gameFinished: false, winner: null }
}

const getGameResultType = (gameNum) => {
  const result = getGameResult(gameNum)

  if (result === 'AÂãù') return 'success'
  if (result === 'BÂãù') return 'warning'

  return 'default'
}

const getScoreInputStatus = (gameNum) => {
  const aScore = props.modelValue[`game${gameNum}_a_score`] || 0
  const bScore = props.modelValue[`game${gameNum}_b_score`] || 0

  if (aScore === 0 && bScore === 0) return null

  const validation = validateSoftTennisScore(aScore, bScore, gameNum)

  if (!validation.isValid) {
    return { type: 'error', message: validation.message }
  }

  if (validation.gameFinished) {
    return { type: 'success', message: getGameResult(gameNum) }
  }

  return null
}

const getGameTitle = (gameNum) => {
  return isTiebreakGame(gameNum) ? `Tiebreak` : `Á¨¨${gameNum}Â±Ä`
}

// ÂêåÊ≠•Ë©≥Á¥∞ÊØîÂàÜÂà∞Á∏ΩÊØîÂàÜ
const syncDetailedScores = () => {
  let aWins = 0
  let bWins = 0

  for (let i = 1; i <= maxGames.value; i++) {
    const aScore = props.modelValue[`game${i}_a_score`] || 0
    const bScore = props.modelValue[`game${i}_b_score`] || 0

    if (aScore > 0 || bScore > 0) {
      const validation = validateSoftTennisScore(aScore, bScore, i)

      if (validation.gameFinished && validation.winner) {
        if (validation.winner === 'A') {
          aWins++
        } else {
          bWins++
        }
      }
    }
  }

  // Âè™Âú®ÂàÜÊï∏‰∏çÂêåÊôÇÊâçÊõ¥Êñ∞ÔºåÈÅøÂÖçÁÑ°ÈôêÂæ™Áí∞
  if (props.modelValue.a_games !== aWins || props.modelValue.b_games !== bWins) {
    const updatedValue = {
      ...props.modelValue,
      a_games: aWins,
      b_games: bWins
    }
    emit('update:modelValue', updatedValue)
  }
}

// ‰∏ªË¶ÅÊñπÊ≥ï
const toggleAdvancedSettings = () => {
  if (props.readOnly) return

  showAdvancedSettings.value = !showAdvancedSettings.value
}

const setFirstServe = (side) => {
  if (props.readOnly) return

  const updatedValue = { ...props.modelValue, first_serve_side: side }
  emit('update:modelValue', updatedValue)
}

const toggleMobileGame = (gameNum) => {
  const index = collapsedGames.value.indexOf(gameNum)
  if (index > -1) {
    collapsedGames.value.splice(index, 1)
  } else {
    collapsedGames.value.push(gameNum)
  }
}

const adjustScore = (field, delta) => {
  if (props.readOnly || !props.allowScoreAdjustment) return

  const currentValue = props.modelValue[field] || 0
  const newValue = currentValue + delta

  if (newValue >= 0 && newValue <= scoreInputMax.value) {
    const updatedValue = { ...props.modelValue, [field]: newValue }
    emit('update:modelValue', updatedValue)
    emit('score-changed', { field, oldValue: currentValue, newValue, delta })

    if (hasDetailedScoreData.value && delta !== 0) {
      message.warning('ÊâãÂãïË™øÊï¥Á∏ΩÂàÜÂèØËÉΩËàáË©≥Á¥∞ÊØîÂàÜ‰∏ç‰∏ÄËá¥')
    }
  }
}

const updateGameStatistics = () => {
  if (props.readOnly) return

  let aWins = 0
  let bWins = 0
  let hasInvalidScore = false
  let invalidMessage = ''

  for (let i = 1; i <= maxGames.value; i++) {
    const aScore = props.modelValue[`game${i}_a_score`] || 0
    const bScore = props.modelValue[`game${i}_b_score`] || 0

    if (aScore > 0 || bScore > 0) {
      const validation = validateSoftTennisScore(aScore, bScore, i)

      if (!validation.isValid) {
        hasInvalidScore = true
        const gameType = isTiebreakGame(i) ? 'TiebreakÂ±Ä' : 'Â±Ä'
        invalidMessage = `Á¨¨${i}${gameType}: ${validation.message}`
        break
      }

      if (validation.gameFinished && validation.winner) {
        if (validation.winner === 'A') {
          aWins++
        } else {
          bWins++
        }
      }
    }
  }

  if (hasInvalidScore) {
    message.error(invalidMessage, { duration: 5000 })
    return
  }

  const updatedValue = {
    ...props.modelValue,
    a_games: aWins,
    b_games: bWins
  }

  emit('update:modelValue', updatedValue)

  if (matchCompleted.value && (aWins > 0 || bWins > 0)) {
    const winner = aWins >= gamesToWin.value ? props.teamAName : props.teamBName
    message.success(`${winner} Áç≤ÂãùÔºÅ`, { duration: 3000 })
    emit('match-completed', { winner })
  }
}

const showScoreDetails = () => {
  if (hasDetailedScoreData.value) {
    showScoreModal.value = true
  } else {
    if (!props.readOnly) {
      message.info('ÁÑ°Ë©≥Á¥∞ÊØîÂàÜË®òÈåÑ')
    }
  }
}

// Áõ£ËÅΩÂô®
watch(
  () => props.modelValue.match_format,
  (newFormat) => {
    if (newFormat && !props.readOnly) {
      const updatedValue = { ...props.modelValue }

      for (let i = 1; i <= 9; i++) {
        updatedValue[`game${i}_a_score`] = 0
        updatedValue[`game${i}_b_score`] = 0
      }

      collapsedGames.value = []
      emit('update:modelValue', updatedValue)
      message.info('Ë≥ΩÂà∂Â∑≤ËÆäÊõ¥ÔºåÊØîÂàÜÂ∑≤ÈáçÁΩÆ')
    }
  }
)

// Áõ£ËÅΩ modelValue ËÆäÂåñ‰∏¶Ëá™ÂãïÂêåÊ≠•
watch(
  () => props.modelValue,
  () => {
    if (hasDetailedScoreData.value) {
      nextTick(() => {
        syncDetailedScores()
      })
    }
  },
  { deep: true, immediate: false }
)

// Ê®°ÂºèÂàùÂßãÂåñ
watch(
  () => [props.readOnly, props.mode],
  ([newReadOnly, newMode]) => {
    if (newReadOnly || newMode === 'view') {
      showAdvancedSettings.value = true
    } else if (newMode === 'edit') {
      showAdvancedSettings.value = true
    } else if (newMode === 'add') {
      showAdvancedSettings.value = false
    }
  },
  { immediate: true, flush: 'post' }
)

defineExpose({
  resetComponentState: () => {
    showAdvancedSettings.value = false
    showScoreModal.value = false
    collapsedGames.value = []
  },
  resetScores: () => {
    if (props.readOnly) return

    const updatedValue = { ...props.modelValue }
    for (let i = 1; i <= maxGames.value; i++) {
      updatedValue[`game${i}_a_score`] = 0
      updatedValue[`game${i}_b_score`] = 0
    }
    updatedValue.a_games = 0
    updatedValue.b_games = 0
    emit('update:modelValue', updatedValue)

    showAdvancedSettings.value = false
    collapsedGames.value = []
    message.info('Â∑≤ÈáçÁΩÆ')
  },
  syncDetailedScores
})
</script>

<style scoped>
@import "@/assets/css/components/match/match-score-display.css";

/* Âè™ËÆÄÊ®°ÂºèÊ®£Âºè */
.match-score-display-container.readonly-mode {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 1rem;
  border: 2px solid #e9ecef;
}

.readonly-mode .score-buttons {
  display: none;
}

.readonly-mode .score-display-enhanced {
  cursor: default !important;
}

.readonly-mode .score-display-enhanced.clickable {
  cursor: default !important;
}

.readonly-mode .serve-button[disabled] {
  opacity: 0.6;
  cursor: not-allowed;
}

.readonly-mode .game-score-card.readonly-card {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
}

.readonly-mode .game-score-card.readonly-card :deep(.n-input-number.n-input-number--disabled) {
  background-color: #f8f9fa !important;
  border-color: #dee2e6 !important;
  cursor: default !important;
}

.readonly-mode .game-score-card.readonly-card :deep(.n-input__input-el[disabled]) {
  color: #495057 !important;
  background-color: #f8f9fa !important;
}

.readonly-mode .card-game-header {
  background: linear-gradient(135deg, #f1f3f5 0%, #e9ecef 100%);
  padding: 0.5rem;
  border-radius: 6px;
  margin-bottom: 0.5rem;
}

.readonly-mode .real-time-statistics {
  background: white;
  border-radius: 8px;
  padding: 1rem;
  border: 1px solid #dee2e6;
}

.readonly-mode::before {
  content: 'üìñ ÊØîË≥ΩË≥áÊñôÊ™¢Ë¶ñÊ®°Âºè';
  display: block;
  text-align: center;
  font-size: 0.875rem;
  color: #6c757d;
  background: #e9ecef;
  padding: 0.5rem;
  border-radius: 6px;
  margin-bottom: 1rem;
  font-weight: 500;
}
</style>